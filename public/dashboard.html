<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelloGrade Dashboard</title>

    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/ustyles.css">
    <script src="js/uscripts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Header -->
    <header class="sticky top-0 z-50 flex items-center justify-between px-4 py-2 bg-blue-600 text-white">
        <div class="flex items-center">
            <a href="https://hellograde.onrender.com/">
                <img src="images/icon.png" alt="HelloGrade Icon" class="h-12 mr-3">
            </a>
            <h1 class="text-xl font-bold">HelloGrade</h1>
        </div>
        <nav>
            <ul id="navMenu" class="flex flex-row gap-4">             
                <li><a href="dashboard.html" title="Dashboard"><span class="material-icons">dashboard</span></a></li>
                <li><a href="settings.html" title="Settings"><span class="material-icons">settings</span></a></li>
                <li><a href="help.html" title="Help"><span class="material-icons">help_outline</span></a></li>
                <li><a href="login.html" title="Sign In"><span class="material-icons">login</span></a></li>
            </ul>
        </nav>
    </header>

    <!-- Welcome Section -->
    <section class="welcome-section">
        <h2>Welcome, <span id="studentName">[User's Name]</span>!</h2>
        <p id="studentID">Student ID: <span>[Student ID]</span></p>
                <!-- Dropdown Menu for Classes -->
                <div class="classes-dropdown">
                    <label for="classesSelect">Select a Class:</label>
                    <select id="classesSelect" onchange="fetchGradesForCourse(this.value)">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
    </section>

    <!-- Main Content -->
    <main>
        <section class="grades-section">


            <!-- Grade Table Container -->
            <div id="gradeTableContainer" class="content">
                <!-- Content will be dynamically inserted here -->
            </div>
        </section>
    </main>



    <!-- Footer -->
    <footer class="bg-blue-600 text-white text-center py-3">
        <p>&copy; 2024 HelloGrade. All Rights Reserved.</p>
    </footer>

     <!-- Scripts -->
     <script>
        // Theme Toggle
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');

            // Set default theme based on localStorage or default to light
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeIcon.textContent = savedTheme === 'dark' ? 'brightness_7' : 'brightness_4';

            // Toggle theme and update localStorage
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                themeIcon.textContent = newTheme === 'dark' ? 'brightness_7' : 'brightness_4';
                localStorage.setItem('theme', newTheme);
            });
        });

        // Session Validation and Fetch User Details
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Session validation
                const sessionResponse = await fetch('/session-check', {
                    method: 'GET',
                    credentials: 'include',
                });

                const sessionData = await sessionResponse.json();

                if (!sessionResponse.ok || !sessionData.authenticated) {
                    window.location.href = 'login.html';
                    return;
                }

                if (sessionData.role === 'admin') {
                    window.location.href = 'admin_dashboard.html';
                    return;
                } else if (sessionData.role !== 'student') {
                    window.location.href = '403.html';
                    return;
                }

                // Fetch user details after session validation
                await fetchStudentDetails();
            } catch (error) {
                console.error('Error during session validation:', error);
                window.location.href = 'login.html';
            }
        });

        async function fetchStudentDetails() {
            try {
                const response = await fetch('/user-details', {
                    method: 'GET',
                    credentials: 'include',
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch user details. Status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    document.getElementById('studentName').textContent = `${data.user.firstName} ${data.user.lastName}`;
                    document.getElementById('studentID').textContent = data.user.studentIDNumber;

                    // Fetch and display courses
                    await fetchCourses(data.user.studentIDNumber);
                } else {
                    console.error('Failed to fetch user details:', data.message);
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
            }
        }

        // Fetch Courses and Populate Dropdown
        async function fetchCourses(studentIDNumber) {
            try {
                const response = await fetch(`/get-grades/${studentIDNumber}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    populateCourses(data.gradeDataArray);
                } else {
                    console.error('Failed to fetch courses:', data.message);
                }
            } catch (error) {
                console.error('Error fetching courses:', error);
            }
        }

        function populateCourses(courseArray) {
            const classesSelect = document.getElementById('classesSelect');

            if (!classesSelect) {
                console.error('Classes select element not found in DOM');
                return;
            }

            classesSelect.innerHTML = ''; // Clear existing options

            courseArray.forEach((course) => {
                const option = document.createElement('option');
                option.value = course.courseID;
                option.textContent = `${course.courseID} - ${course.courseDescription}`;
                classesSelect.appendChild(option);
            });

            // Display grades for the first course by default
            if (courseArray.length > 0) {
                fetchGradesForCourse(courseArray[0].courseID);
            }
        }

        // Fetch Grades for Selected Course
        async function fetchGradesForCourse(courseID) {
            const studentIDNumber = document.getElementById('studentID').textContent;

            try {
                const response = await fetch(`/get-grades/${studentIDNumber}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    const courseData = data.gradeDataArray.find(course => course.courseID === courseID);
                    if (courseData) displayGrades(courseData);
                } else {
                    console.error('Failed to fetch grades:', data.message);
                }
            } catch (error) {
                console.error('Error fetching grades:', error);
            }
        }

        // Display Grades in the Grade Table Container
        function displayGrades(courseData) {
            const gradeTableContainer = document.getElementById('gradeTableContainer');
            gradeTableContainer.innerHTML = `
                <div class="content-inner">
                    <!-- Course Name at the Top -->
                    <h3 id="courseInfo">${courseData.courseID} - ${courseData.courseDescription}</h3>
                    
                    <!-- Grade Table -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Grade Category</th>
                                    <th>Midterm</th>
                                    <th>Finals</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Attendance</td><td>${courseData.midtermAttendance || 'No entry'}</td><td>${courseData.finalsAttendance || 'No entry'}</td></tr>
                                <tr><td>Class Standing</td><td>${courseData.midtermClassStanding || 'No entry'}</td><td>${courseData.finalsClassStanding || 'No entry'}</td></tr>
                                <tr><td>Exams</td><td>${courseData.midtermExam || 'No entry'}</td><td>${courseData.finalExam || 'No entry'}</td></tr>
                                <tr><td>Midterm Grade</td><td>${courseData.midtermGrade || 'No entry'}</td><td rowspan="2">${courseData.finalGrade || 'No entry'}</td></tr>
                                <tr><td>Transmuted Midterm Grade</td><td>${courseData.transmutedMidtermGrade || 'No entry'}</td></tr>
                                <tr><td>Transmuted Final Grade</td><td colspan="2">${courseData.transmutedFinalGrade || 'No entry'}</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Logout Functionality
        document.getElementById('logoutLink').addEventListener('click', function (event) {
            event.preventDefault();

            fetch('/logout', {
                method: 'POST',
                credentials: 'include',
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = 'index.html';
                } else {
                    console.error('Logout failed');
                }
            })
            .catch(error => {
                console.error('Error during logout:', error);
            });
        });
    </script>
</body>
</html>
