<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="View your attendance summary on HelloGrade. Stay updated with your class attendance records, including dates, times, status, and remarks. Ensure you're on track with your academic commitments." />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelloGrade Attendance Summary</title>

    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/ustyles.css">
    <script src="js/uscripts.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <!-- Header -->
    <header class="sticky top-0 z-50 flex items-center justify-between px-4 py-2 bg-green-600 text-white">
        <div class="flex items-center">
            <a href="https://hellograde.onrender.com/">
                <img src="images/icon.png" alt="HelloGrade Icon" class="h-12 mr-3">
            </a>
            <h1 class="text-xl font-bold">HelloGrade</h1>
        </div>
        <nav>
            <ul id="navMenu" class="flex flex-row gap-4">
                <li><a href="dashboard.html" title="Dashboard"><span class="material-icons">dashboard</span></a></li>
                <li><a href="attendance.html" title="Attendance Summary"><span class="material-icons">assignment</span></a></li>
                <li><a id="logoutLink" href="login.html" title="Sign Out"><span class="material-icons">logout</span></a></li>
            </ul>
        </nav>
    </header>

    <!-- Welcome Section -->
    <section class="welcome-section bg-white shadow-md p-4 rounded-lg mx-auto my-4 max-w-md">
        <div class="welcome-dropdown">
            <p class="text-xl sm:text-2xl font-semibold text-green-white text-center">
                Hello, <span id="studentName">[User's Name]</span>!
            </p>
            <p class="text-gray-600 text-center mb-4">
                Student ID: <span id="studentID">[Student ID]</span>
            </p>
            <select id="classesSelect" class="w-full mt-2 mb-4 p-2 border border-gray-300 rounded">
                <!-- Options will be dynamically populated -->
            </select>
        </div>
    </section>

    <!-- Attendance Table -->
    <section class="attendance-section">
        <div class="content overflow-x-auto mx-4">
            <h3 class="text-lg font-semibold text-green-600 mb-4" id="courseTitle"></h3>
            <table class="w-full bg-white border border-gray-200 text-center">
                <thead class="bg-green-600 text-white font-semibold">
                    <tr>
                        <th class="py-2">Date</th>
                        <th class="py-2">Time</th>
                        <th class="py-2">Status</th>
                        <th class="py-2">Remarks</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    <!-- Rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-green-600 text-white text-center py-3 mt-4">
        <p>&copy; 2024 HelloGrade. All Rights Reserved.</p>
    </footer>

    <!-- Scripts -->
    <script>
        // Session Validation and Fetch User Details
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Session validation
                const sessionResponse = await fetch('/session-check', {
                    method: 'GET',
                    credentials: 'include',
                });

                const sessionData = await sessionResponse.json();

                if (!sessionResponse.ok || !sessionData.authenticated) {
                    window.location.href = 'login.html';
                    return;
                }

                if (sessionData.role === 'admin') {
                    window.location.href = 'admin_dashboard.html';
                    return;
                } else if (sessionData.role !== 'student') {
                    window.location.href = '403.html';
                    return;
                }

                // Fetch user details after session validation
                await fetchStudentDetails();
            } catch (error) {
                console.error('Error during session validation:', error);
                window.location.href = 'login.html';
            }
        });

        async function fetchStudentDetails() {
            try {
                const response = await fetch('/user-details', {
                    method: 'GET',
                    credentials: 'include',
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch user details. Status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    document.getElementById('studentName').textContent = `${data.user.firstName} ${data.user.lastName}`;
                    document.getElementById('studentID').textContent = data.user.studentIDNumber;

                    // Fetch and display courses
                    await fetchCourses(data.user.studentIDNumber);
                } else {
                    console.error('Failed to fetch user details:', data.message);
                }
            } catch (error) {
                console.error('Error fetching user details:', error);
            }
        }

        // Fetch Courses and Populate Dropdown
        async function fetchCourses(studentIDNumber) {
            try {
                const response = await fetch(`/get-courses/${studentIDNumber}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    populateCourses(data.courseDataArray);
                } else {
                    console.error('Failed to fetch courses:', data.message);
                }
            } catch (error) {
                console.error('Error fetching courses:', error);
            }
        }

        function populateCourses(courseArray) {
            const classesSelect = document.getElementById('classesSelect');
            classesSelect.innerHTML = ''; // Clear options

            courseArray.forEach(course => {
                const option = document.createElement('option');
                option.value = course.courseID;
                option.textContent = `${course.courseID} - ${course.courseDescription}`;
                classesSelect.appendChild(option);
            });

            // Display attendance for the first course by default
            if (courseArray.length > 0) {
                fetchAttendanceForCourse(courseArray[0].courseID);
                document.getElementById('courseTitle').textContent = `${courseArray[0].courseID} - ${courseArray[0].courseDescription}`;
            }

            // Event Listener for Dropdown Change
            classesSelect.addEventListener('change', function () {
                const selectedCourseID = this.value;
                const selectedCourse = courseArray.find(course => course.courseID === selectedCourseID);
                document.getElementById('courseTitle').textContent = `${selectedCourse.courseID} - ${selectedCourse.courseDescription}`;
                fetchAttendanceForCourse(selectedCourseID);
            });
        }

        // Fetch Attendance for Selected Course
        async function fetchAttendanceForCourse(courseID) {
            const studentIDNumber = document.getElementById('studentID').textContent;

            try {
                const response = await fetch(`/get-attendance/${studentIDNumber}/${courseID}`, { credentials: 'include' });
                const data = await response.json();

                if (data.success) {
                    displayAttendance(data.attendanceDataArray);
                } else {
                    console.error('Failed to fetch attendance:', data.message);
                }
            } catch (error) {
                console.error('Error fetching attendance:', error);
            }
        }

        // Display Attendance in Table
        function displayAttendance(attendanceDataArray) {
            const attendanceTableBody = document.getElementById('attendanceTableBody');
            attendanceTableBody.innerHTML = ''; // Clear previous data

            if (attendanceDataArray.length === 0) {
                attendanceTableBody.innerHTML = '<tr><td colspan="4" class="py-4">No attendance records found.</td></tr>';
                return;
            }

            attendanceDataArray.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${record.attDate || ""}</td>
                    <td class="py-2">${record.attTime || ""}</td>
                    <td class="py-2">${record.attStatus || ""}</td>
                    <td class="py-2">${record.attRemarks || ""}</td>
                `;
                attendanceTableBody.appendChild(row);
            });
        }


        // Logout Functionality
        document.getElementById('logoutLink').addEventListener('click', function (event) {
            event.preventDefault();

            fetch('/logout', {
                method: 'POST',
                credentials: 'include',
            })
                .then(response => {
                    if (response.ok) {
                        window.location.href = 'index.html';
                    } else {
                        console.error('Logout failed');
                    }
                })
                .catch(error => {
                    console.error('Error during logout:', error);
                });
        });
    </script>
</body>
</html>
